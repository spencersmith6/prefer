import random
import numpy as np
import pickle
from utils.db_utils import *


def get_new_item_id(user_reviews):
    item_id = predict_top_item(user_reviews)
    conn = getConn('db_admin/creds.json')
    cur = getCur(conn)
    item = get_item_by_id(cur, item_id=item_id)
    return item


def predict_top_item(user_reviews):

    # load pretrained models
    with open('data/nmf.pkl', 'rb') as fid:
        nmf_model = pickle.load(fid)

    with open('data/item_encoder.pkl', 'rb') as fid:
        le_item = pickle.load(fid)

    # get item embeddings
    item_embeddings = nmf_model.components_
    n_items = item_embeddings.shape[1]

    # create user item vector
    user_item_vector = np.zeros(n_items)
    rated_items = le_item.transform(user_reviews['asin'])
    ratings = np.array(user_reviews['overall'])
    for i, r in zip(rated_items,ratings):
        user_item_vector[i] = r

    # make predictions
    user_embeddings = nmf_model.transform(user_item_vector.reshape(1, -1))
    item_embeddings = nmf_model.components_
    predictions = np.squeeze(np.dot(user_embeddings, item_embeddings))
    top_items = np.argsort(-predictions)[:10]  # want to sort in reverse order

    #TODO: work around for the fact that we keep returning the same item
    top_item = np.random.choice(top_items, 1)[0]

    return le_item.inverse_transform(top_item)